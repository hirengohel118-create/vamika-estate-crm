<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vamika Estate CRM</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.theme-dark {
      --bg: #020617;
      --card-bg: #020617;
      --card-elevated: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --primary-soft: rgba(59, 130, 246, 0.15);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
    }

    body.theme-light {
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --card-elevated: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #dc2626;
    }

    /* TOP BAR + SIDEBAR */

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px 0 8px;
      z-index: 40;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-bar-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .hamburger-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
    }

    .hamburger-icon {
      width: 16px;
      height: 12px;
      position: relative;
    }

    .hamburger-icon span {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .hamburger-icon span:nth-child(1) { top: 0; }
    .hamburger-icon span:nth-child(2) { top: 5px; }
    .hamburger-icon span:nth-child(3) { top: 10px; }

    .install-btn {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: #e5e7eb;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .install-btn span {
      font-size: 14px;
    }

    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 39;
    }

    .sidebar-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 70%;
      max-width: 320px;
      background: rgba(15, 23, 42, 0.98);
      border-right: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      transform: translateX(-100%);
      transition: transform 0.25s ease;
      z-index: 40;
      padding: 14px 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    body.theme-light .sidebar {
      background: rgba(255, 255, 255, 0.98);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-weight: 800;
      font-size: 24px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .sidebar-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .sidebar-menu {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-item {
      border-radius: 999px;
      padding: 9px 11px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
    }

    .sidebar-item span.icon {
      font-size: 15px;
      width: 20px;
      text-align: center;
    }

    .sidebar-item.active {
      background: var(--primary-soft);
      color: var(--text);
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 10px;
      color: var(--muted);
    }

    /* APP SHELL */

    .app-shell {
      max-width: 900px;
      margin: 0 auto;
      padding: 72px 16px 40px; /* top padding for top-bar */
    }

    .header-card {
      background: var(--card-elevated);
      border-radius: 20px;
      padding: 16px 16px 14px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .logo-pill {
      width: 54px;
      height: 54px;
      border-radius: 18px;
      background:#f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 30px;
      font-weight: 800;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      flex-shrink: 0;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-name-main {
      font-size: 20px;
      font-weight: 750;
      letter-spacing: 0.02em;
    }

    .brand-name-sub {
      font-size: 20px;
      font-weight: 650;
      color: var(--muted);
    }

    .owner-line {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .owner-line span.dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: var(--muted);
    }

    /* Tab row hidden (we use sidebar now) */
    .tabs-row {
      display: none;
    }

    .content-card {
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 18px;
      margin-top: 8px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 650;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      color: var(--muted);
    }

    .primary-btn, .ghost-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .primary-btn {
      background: var(--primary);
      color: #ffffff;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .ghost-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      margin-top: 4px;
    }

    .search-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 7px 11px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
    }

    body.theme-light .search-input {
      background: #ffffff;
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--card-bg);
      color: var(--muted);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      margin-bottom: 10px;
    }

    

    .empty-state {
      border-radius: 16px;
      padding: 16px 14px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      text-align: left;
      background: var(--card-bg);
      margin-top: 4px;
    }

    

    .empty-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .empty-text {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .leads-list,
    .projects-list,
    .followup-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .item-card {
      border-radius: 14px;
      padding: 9px 10px;
      background: var(--card-elevated);
      border: 1px solid rgba(148, 163, 184, 0.55);
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      cursor: pointer;
    }

    

    .item-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .item-title {
      font-weight: 600;
      font-size: 13px;
    }

    .status-pill {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(34, 197, 94, 0.14);
      color: #4ade80;
    }

    .status-pill.overdue {
      background: rgba(248, 113, 113, 0.16);
      color: #fca5a5;
    }

    .item-line {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .item-line.full {
      justify-content: flex-start;
    }

    .item-line.full span {
      margin-right: 8px;
    }

    .item-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .mini-btn {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      font-size: 10px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .section-label {
      font-size: 13px;
      font-weight: 600;
      margin: 12px 0 6px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    @media (min-width: 640px) {
      .settings-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field-label {
      color: var(--muted);
    }

    .field-input,
    .field-select {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 9px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
    }

    body.theme-light .field-input,
    body.theme-light .field-select {
      background: #ffffff;
    }

    .field-input::placeholder {
      color: var(--muted);
    }

    .theme-toggle-row {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      gap: 3px;
      margin-top: 4px;
    }

    body.theme-light .theme-toggle-row {
      background: rgba(243, 244, 246, 0.95);
    }

    .theme-btn {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 13px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .theme-btn.active {
      background: #facc15;
      color: #0f172a;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    .theme-btn.dark-active {
      background: #0f172a;
      color: #e5e7eb;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }

    /* NEW theme accent controls */
    .theme-accent-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .theme-color-input {
      width: 42px;
      height: 32px;
      padding: 0;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
    }

    .theme-slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .theme-slider-row span {
      flex-shrink: 0;
      font-size: 11px;
      color: var(--muted);
    }

    .theme-slider-row input[type="range"] {
      flex: 1;
    }

    .export-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .stat-pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .footer-note {
      margin-top: 14px;
      font-size: 10px;
      color: var(--muted);
      text-align: center;
    }

    /* Modal styles */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.75);
      z-index: 50;
    }

    .modal.hidden {
      display: none;
    }

    .modal-panel {
      width: 92%;
      max-width: 420px;
      background: var(--card-elevated);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      padding: 14px 14px 16px;
      max-height: 90vh;
      overflow-y: auto;
    }

    body.theme-light .modal-panel {
      background: #ffffff;
    }

    .modal-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 650;
    }

    .modal-close-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      color: var(--muted);
      cursor: pointer;
    }

    .modal-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 10px;
    }

    .danger-text {
      color: var(--danger);
    }

    .history-list {
      margin-top: 6px;
      border-left: 2px solid rgba(148, 163, 184, 0.6);
      padding-left: 10px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-item {
      position: relative;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: -11px;
      top: 4px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary);
    }

    .history-date {
      font-weight: 500;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <!-- Top bar and sidebar -->
  <div class="top-bar">
    <div class="top-left">
      <button id="menuToggle" class="hamburger-btn" aria-label="Open menu">
        <div class="hamburger-icon">
          <span></span><span></span><span></span>
        </div>
      </button>
      <div class="top-bar-title">Vamika Estate</div>
    </div>
    <button id="installBtn" class="install-btn">
      <span>‚¨á</span>
      <span>Install</span>
    </button>
  </div>

  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <nav id="sidebar" class="sidebar" aria-label="Main navigation">
    <div class="sidebar-header">
      <div class="sidebar-logo">V</div>
      <div>
        <div class="sidebar-title">Vamika Estate</div>
        <div class="sidebar-subtitle">Hiren Gohel ¬∑ <span id="sidebarPhone">7046869462</span></div>
      </div>
    </div>

    <div class="sidebar-menu">
      <button class="sidebar-item active" data-section="leads">
        <span class="icon">üë§</span>
        <span>Leads</span>
      </button>
      <button class="sidebar-item" data-section="projects">
        <span class="icon">üè¢</span>
        <span>Projects</span>
      </button>
      
<button class="sidebar-item" data-section="followups" style="position:relative;">
    <span class="icon">‚è±Ô∏è</span>
    <span>Follow-ups</span>
    <span id="sidebarFollowCount"
          style="position:absolute; right:16px; top:50%; transform:translateY(-50%);
                 background:#ef4444; color:white; font-size:10px; padding:2px 6px;
                 border-radius:999px; display:none;">
    </span>
</button>

      <button class="sidebar-item" data-section="settings">
        <span class="icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </button>
    </div>

    <div class="sidebar-footer">
      All data stays on this device. Take a JSON backup before changing phone.
    </div>
  </nav>

  <div class="app-shell">
    <header class="header-card">
      <div class="logo-pill">V</div>
      <div class="brand-text">
        <div>
          <span class="brand-name-main">Vamika</span>
          <span class="brand-name-sub">Estate</span>
        </div>
        <div class="owner-line">
          <span id="headerOwner">Hiren Gohel</span>
          <span class="dot"></span>
          <span id="headerPhone">7046869462</span>
        </div>
      </div>
    </header>

    <main class="content-card">
      <!-- Leads TAB -->
      <section id="tab-leads" class="tab-content active">
        <div class="section-header-row">
          <div class="section-title">Leads</div>
          <button class="primary-btn" id="btnNewLead">
            + New Lead
          </button>
        </div>

        <div class="search-row">
          <input id="leadSearch" class="search-input" placeholder="Search leads by name, phone, location..." />
        </div>

        <div class="chip">
          üîÅ Today's & overdue follow-ups will also show on ‚ÄúFollow-ups‚Äù tab
        </div>

        <div id="emptyLeads" class="empty-state">
          <div class="empty-title">No leads yet</div>
          <div class="empty-text">
            Start by adding your first lead. You can track requirements, budget, follow-up dates & notes in one place.
          </div>
          <button class="primary-btn" id="btnEmptyNewLead">+ Add first lead</button>
        </div>

        <div id="leadsList" class="leads-list"></div>
      </section>

      <!-- Projects TAB -->
      <section id="tab-projects" class="tab-content">
        <div class="section-header-row">
          <div class="section-title">Projects</div>
          <button class="primary-btn" id="btnNewProject">
            + New Project
          </button>
        </div>

        <div class="search-row">
          <input id="projectSearch" class="search-input" placeholder="Search projects by name, location..." />
        </div>

        <div id="emptyProjects" class="empty-state">
          <div class="empty-title">No projects added</div>
          <div class="empty-text">
            Add projects with configuration, location, price range & highlights to quickly share with clients.
          </div>
          <button class="primary-btn" id="btnEmptyNewProject">+ Add first project</button>
        </div>

        <div id="projectsList" class="projects-list"></div>
      </section>

      <!-- Follow-ups TAB -->
      <section id="tab-followups" class="tab-content">
        <div class="section-header-row">
          <div class="section-title">Follow-ups</div>
          <span class="pill">Today's & overdue only</span>
        </div>

        <div id="emptyFollowups" class="empty-state">
          <div class="empty-title">No follow-ups for now</div>
          <div class="empty-text">
            When you set a next follow-up date for any lead, it will automatically appear here when due and stay until completed.
          </div>
        </div>

        <div id="followupsList" class="followup-list"></div>
      </section>

      <!-- Settings TAB -->
      <section id="tab-settings" class="tab-content">
        <div class="section-header-row">
          <div class="section-title">Settings & Profile</div>
          <span class="pill">Local to this device</span>
        </div>

        <div class="section-label">Theme & Appearance
        <div class="section-label">Theme Presets</div>
        <div class="settings-grid">
          <button class="primary-btn" onclick="applyAccentTheme('#3B82F6',70)">Matte Blue</button>
          <button class="primary-btn" onclick="applyAccentTheme('#000000',90)">Matte Black</button>
          <button class="primary-btn" onclick="applyAccentTheme('#D4AF37',60)">Rich Gold</button>
          <button class="primary-btn" onclick="applyAccentTheme('#C81E1E',70)">Royal Red</button>
          <button class="primary-btn" onclick="applyAccentTheme('#065F46',70)">Forest Green</button>
        </div>
</div>
        <div class="field-group">
          <label class="field-label">Theme accent (HEX / picker)</label>
          <div class="theme-accent-row">
            <input id="themeAccent" class="field-input" placeholder="#3B82F6" />
            <input id="themeAccentPicker" type="color" class="theme-color-input" />
          </div>
          <div class="theme-slider-row">
            <span>Matte depth</span>
            <input id="themeDepth" type="range" min="0" max="100" />
          </div>
        </div>

        <div class="settings-grid">
          <div class="field-group">
            <label class="field-label">Business name</label>
            <input id="businessName" class="field-input" placeholder="Business name" />
          </div>
          <div class="field-group">
            <label class="field-label">Owner</label>
            <input id="ownerName" class="field-input" placeholder="Owner name" />
          </div>
          <div class="field-group">
            <label class="field-label">Phone</label>
            <input id="ownerPhone" class="field-input" placeholder="Phone number" />
          </div>
        </div>

        <div class="field-group" style="margin-top:10px;">
          <label class="field-label">Logo (PNG/JPG)</label>
          <input id="logoFile" type="file" accept="image/*" class="field-input" />
        </div>

        <div style="margin-top: 10px;">
          <button class="ghost-btn" id="btnSaveProfile">Save Profile</button>
        </div>

        <div class="section-label">Theme</div>
        <div class="theme-toggle-row">
          <button id="btnLight" class="theme-btn">‚òÄÔ∏è</button>
          <button id="btnDark" class="theme-btn">üåô</button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">
          Choose between light and dark mode. Your preference is saved on this device.
        </div>

        <div class="section-label">Export & Backup</div>
        <div class="export-row">
          <button class="ghost-btn" id="btnExportCsv">Export Leads (CSV)</button>
          <button class="ghost-btn" id="btnExportExcel">Export Leads (Excel)</button>
        </div>

        <div class="export-row" style="margin-top:8px;">
          <button class="ghost-btn" id="btnDownloadJson">Download JSON Backup</button>
          <label class="ghost-btn" style="cursor:pointer;">
            <input id="restoreFile" type="file" accept="application/json" style="display:none;" />
            Restore from JSON
          </label>
        </div>

        <div class="stats-row">
          <div class="stat-pill" id="statTotalLeads">Total leads: 0</div>
          <div class="stat-pill" id="statTotalProjects">Total projects: 0</div>
        </div>

        <div class="footer-note">
          All data is stored locally in your browser (this device only). Take a JSON backup before changing devices.
        </div>
      </section>
    </main>
  </div>

  <!-- Lead Modal (Add / Edit) -->
  <div id="leadModal" class="modal hidden" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-header-row">
        <div class="modal-title" id="leadModalTitle">Add Lead</div>
        <button class="modal-close-btn" data-close-lead>&times;</button>
      </div>

      <div class="settings-grid">
        <div class="field-group">
          <label class="field-label">Name *</label>
          <input id="leadName" class="field-input" placeholder="Client name" />
        </div>
        <div class="field-group">
          <label class="field-label">Phone Number *</label>
          <input id="leadPhone" class="field-input" placeholder="Phone number" />
        </div>
        <div class="field-group">
          <label class="field-label">Segment</label>
          <select id="leadSegment" class="field-select">
            <option>Residential</option>
            <option>Commercial</option>
            <option>Plot</option>
            <option>Other</option>
          </select>
        </div>
        <div class="field-group">
          <label class="field-label">Requirement</label>
          <input id="leadRequirement" class="field-input" placeholder="2 BHK, 3 BHK, etc." />
        </div>
        <div class="field-group">
          <label class="field-label">Location</label>
          <input id="leadLocation" class="field-input" placeholder="Preferred location" />
        </div>
        <div class="field-group">
          <label class="field-label">Budget</label>
          <input id="leadBudget" class="field-input" placeholder="e.g. 60L‚Äì80L" />
        </div>
        <div class="field-group">
          <label class="field-label">Next follow-up (date & time)</label>
          <input id="leadNextFollow" type="datetime-local" class="field-input" />
        </div>
        <div class="field-group">
          <label class="field-label">Notes</label>
          <input id="leadNotes" class="field-input" placeholder="Site visit, call back, etc." />
        </div>
      </div>

      <div class="modal-actions">
        <button class="ghost-btn" data-close-lead>Cancel</button>
        <button class="primary-btn" id="btnSaveLead">Save Lead</button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="projectModal" class="modal hidden" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-header-row">
        <div class="modal-title">Add Project</div>
        <button class="modal-close-btn" data-close-project>&times;</button>
      </div>

      <!-- BASIC DETAILS -->
      <div class="section-label">Basic details</div>
      <div class="settings-grid">
        <div class="field-group">
          <label class="field-label">Project name *</label>
          <input id="projectName" class="field-input" placeholder="Project name" />
        </div>

        <div class="field-group">
          <label class="field-label">Location</label>
          <input id="projectLocation" class="field-input" placeholder="Area / road" />
        </div>

        <div class="field-group">
          <label class="field-label">Architect name</label>
          <input id="projectArchitect" class="field-input" placeholder="Architect" />
        </div>

        <div class="field-group">
          <label class="field-label">Land area of project</label>
          <input id="projectLandArea" class="field-input" placeholder="e.g. 2.5 acres / 5000 sq.yd" />
        </div>

        <div class="field-group">
          <label class="field-label">Total units</label>
          <input id="projectUnits" class="field-input" placeholder="e.g. 120 units" />
        </div>

        <div class="field-group">
          <label class="field-label">Total blocks</label>
          <input id="projectBlocks" class="field-input" placeholder="e.g. 4 blocks" />
        </div>

        <div class="field-group">
          <label class="field-label">Total floors</label>
          <input id="projectFloors" class="field-input" placeholder="e.g. G+14" />
        </div>
      </div>

      <!-- BHK + SIZE -->
      <div class="section-label" style="margin-top:12px;">Configurations (BHK & Size)</div>
      <div class="field-group">
        <label class="field-label">Each on new line</label>
        <textarea id="projectConfig" class="field-input" rows="3"
          placeholder="2 BHK - 1200 sq.ft&#10;3 BHK - 1450 sq.ft"></textarea>
      </div>

      <!-- DESCRIPTION POINTS -->
      <div class="section-label" style="margin-top:12px;">Project description (points)</div>
      <div class="field-group">
        <textarea id="projectDescription" class="field-input" rows="3"
          placeholder="Club house with all amenities&#10;Corner plot on main road&#10;Temple inside campus"></textarea>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">
          Har ek point navi line par lakhjo.
        </div>
      </div>

      <!-- RATE DETAILS -->
      <div class="section-label" style="margin-top:12px;">Rate details</div>
      <div class="settings-grid">

        <div class="field-group">
          <label class="field-label">Basic rate</label>
          <input id="rateBasic" class="field-input" placeholder="e.g. 3500" />
          <select id="rateBasicUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select unit</option>
            <option value="per sq.ft">per sq.ft</option>
            <option value="per sq.yd">per sq.yd</option>
            <option value="flat rate">flat rate</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Other expense package</label>
          <input id="rateOtherAmount" class="field-input" placeholder="e.g. 250" />
          <select id="rateOtherUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select</option>
            <option value="per sq.ft">per sq.ft</option>
            <option value="per sq.yd">per sq.yd</option>
            <option value="flat rate">flat rate</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Maintenance deposit</label>
          <input id="rateMaintDepositAmount" class="field-input" placeholder="e.g. 50" />
          <select id="rateMaintDepositUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select</option>
            <option value="per sq.ft">per sq.ft</option>
            <option value="per sq.yd">per sq.yd</option>
            <option value="per month">per month</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Running maintenance</label>
          <input id="rateRunningAmount" class="field-input" placeholder="e.g. 2" />
          <select id="rateRunningUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select</option>
            <option value="per sq.ft per month">per sq.ft per month</option>
            <option value="per sq.yd per month">per sq.yd per month</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">PLC - Garden side</label>
          <input id="ratePlcGardenAmount" class="field-input" placeholder="e.g. 150" />
          <select id="ratePlcGardenUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select unit</option>
            <option value="per sq.ft">per sq.ft</option>
            <option value="per sq.yd">per sq.yd</option>
            <option value="flat rate">flat rate</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">PLC - Road side</label>
          <input id="ratePlcRoadAmount" class="field-input" placeholder="e.g. 100" />
          <select id="ratePlcRoadUnit" class="field-input" style="margin-top:6px;">
            <option value="">Select unit</option>
            <option value="per sq.ft">per sq.ft</option>
            <option value="per sq.yd">per sq.yd</option>
            <option value="flat rate">flat rate</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">FRC (Floor rise charge)</label>
          <input id="rateFrcFrom" class="field-input" placeholder="From which floor? e.g. 5th floor" />
          <input id="rateFrcValue" class="field-input" style="margin-top:6px;"
            placeholder="e.g. ‚Çπ25 per sq.ft per floor" />
        </div>

      </div>

      <div class="modal-actions">
        <button class="ghost-btn" data-close-project>Cancel</button>
        <button class="primary-btn" id="btnSaveProject">Save Project</button>
      </div>
    </div>
  </div>

  <!-- Lead Detail Modal (Full view + history) -->
  <div id="leadDetailModal" class="modal hidden" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-header-row">
        <div class="modal-title">Lead details</div>
        <button class="modal-close-btn" data-close-detail>&times;</button>
      </div>

      <div id="leadDetailBody" style="font-size:12px;"></div>

      <div class="section-label" style="margin-top:10px;">Add follow-up note</div>
      <div class="field-group">
        <label class="field-label">When</label>
        <input id="detailFollowWhen" type="datetime-local" class="field-input" />
      </div>
      <div class="field-group">
        <label class="field-label">Note</label>
        <input id="detailFollowNote" class="field-input" placeholder="What was discussed?" />
      </div>

      <div class="modal-actions">
        <button class="ghost-btn" data-close-detail>Close</button>
        <button class="ghost-btn" id="btnDetailDelete">Delete</button>
        <button class="ghost-btn" id="btnDetailEdit">Edit</button>
        <button class="ghost-btn" id="btnDetailCall">Call</button>
        <button class="primary-btn" id="btnDetailWhatsapp">WhatsApp</button>
        <button class="primary-btn" id="btnDetailAddFollow">Add Note</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      leads: 've_leads',
      projects: 've_projects',
      profile: 've_profile',
      theme: 've_theme'
    };

    const state = {
      leads: [],
      projects: [],
      profile: {
        businessName: 'Vamika Estate',
        ownerName: 'Hiren Gohel',
        phone: '7046869462',
        accent: '#3B82F6',
        accentDepth: 70
      }
    };

    let editingLeadId = null;
    let currentLeadId = null;
    let deferredPrompt = null;

    function loadState() {
      try {
        const leads = localStorage.getItem(STORAGE_KEYS.leads);
        const projects = localStorage.getItem(STORAGE_KEYS.projects);
        const profile = localStorage.getItem(STORAGE_KEYS.profile);

        if (leads) state.leads = JSON.parse(leads);
        if (projects) state.projects = JSON.parse(projects);
        if (profile) Object.assign(state.profile, JSON.parse(profile));
      } catch (e) {
        console.error('Failed to load state', e);
      }
    }

    function saveLeads() {
      localStorage.setItem(STORAGE_KEYS.leads, JSON.stringify(state.leads));
      updateStats();
    }

    function saveProjects() {
      localStorage.setItem(STORAGE_KEYS.projects, JSON.stringify(state.projects));
      updateStats();
    }

    function saveProfile() {
      localStorage.setItem(STORAGE_KEYS.profile, JSON.stringify(state.profile));
    }

    function hexToRgb(hex) {
      if (!hex) return null;
      let c = hex.trim();
      if (c[0] === '#') c = c.slice(1);
      if (c.length === 3) {
        c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];
      }
      if (c.length !== 6) return null;
      const num = parseInt(c, 16);
      return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255
      };
    }

    function rgbToHex(r, g, b) {
      const toHex = (v) => v.toString(16).padStart(2, '0');
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }

    function getLuminance(r, g, b) {
      const a = [r, g, b].map(v => {
        v /= 255;
        return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
      });
      return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
    }

    function mixColors(c1, c2, amount) {
      const r = Math.round(c1.r * (1 - amount) + c2.r * amount);
      const g = Math.round(c1.g * (1 - amount) + c2.g * amount);
      const b = Math.round(c1.b * (1 - amount) + c2.b * amount);
      return { r, g, b };
    }

    function applyAccentTheme(accentHex, depth) {
      const body = document.body;
      if (!accentHex) accentHex = '#3B82F6';
      const accentRgb = hexToRgb(accentHex);
      if (!accentRgb) return;

      if (typeof depth !== 'number') depth = 70;
      depth = Math.min(100, Math.max(0, depth));

      const darkMode = depth >= 50;

      const darkBg = { r: 2, g: 6, b: 23 };
      const darkCard = { r: 15, g: 23, b: 42 };
      const lightBg = { r: 249, g: 250, b: 251 };
      const lightCard = { r: 255, g: 255, b: 255 };

      let bgRgb, cardBgRgb, cardElevatedRgb;

      if (darkMode) {
        const amt = (depth - 50) / 100;
        bgRgb = mixColors(darkBg, accentRgb, 0.15 + amt * 0.25);
        cardBgRgb = mixColors(darkBg, accentRgb, 0.10 + amt * 0.2);
        cardElevatedRgb = mixColors(darkCard, accentRgb, 0.15 + amt * 0.2);
        body.classList.add('theme-dark');
        body.classList.remove('theme-light');
      } else {
        const amt = (50 - depth) / 100;
        bgRgb = mixColors(lightBg, accentRgb, 0.10 + amt * 0.25);
        cardBgRgb = mixColors(lightBg, accentRgb, 0.07 + amt * 0.2);
        cardElevatedRgb = mixColors(lightCard, accentRgb, 0.05 + amt * 0.2);
        body.classList.add('theme-light');
        body.classList.remove('theme-dark');
      }

      const bgHex = rgbToHex(bgRgb.r, bgRgb.g, bgRgb.b);
      const cardBgHex = rgbToHex(cardBgRgb.r, cardBgRgb.g, cardBgRgb.b);
      const cardElevatedHex = rgbToHex(cardElevatedRgb.r, cardElevatedRgb.g, cardElevatedRgb.b);

      const lum = getLuminance(bgRgb.r, bgRgb.g, bgRgb.b);
      const textColor = lum < 0.45 ? '#e5e7eb' : '#0f172a';
      const mutedColor = lum < 0.45 ? '#9ca3af' : '#6b7280';

      body.style.setProperty('--bg', bgHex);
      body.style.setProperty('--card-bg', cardBgHex);
      body.style.setProperty('--card-elevated', cardElevatedHex);
      body.style.setProperty('--text', textColor);
      body.style.setProperty('--muted', mutedColor);
      body.style.setProperty('--primary', accentHex);
      body.style.setProperty('--primary-soft', `rgba(${accentRgb.r}, ${accentRgb.g}, ${accentRgb.b}, 0.16)`);
      body.style.setProperty('--border-subtle', 'rgba(148, 163, 184, 0.35)');

      const logo = document.querySelector('.logo-pill');
      if (logo) {
        logo.style.background = accentHex;
      }
    }

    function applyProfileToUI() {
      const businessInput = document.getElementById('businessName');
      const ownerInput = document.getElementById('ownerName');
      const phoneInput = document.getElementById('ownerPhone');
      const accentInput = document.getElementById('themeAccent');
      const picker = document.getElementById('themeAccentPicker');
      const depthSlider = document.getElementById('themeDepth');

      if (businessInput) businessInput.value = state.profile.businessName || '';
      if (ownerInput) ownerInput.value = state.profile.ownerName || '';
      if (phoneInput) phoneInput.value = state.profile.phone || '';

      const accent = state.profile.accent || '#3B82F6';
      if (accentInput) accentInput.value = accent;
      if (picker) picker.value = accent;

      if (typeof state.profile.accentDepth !== 'number') {
        state.profile.accentDepth = 70;
      }
      if (depthSlider) depthSlider.value = state.profile.accentDepth;

      const headerPhone = document.getElementById('headerPhone');
      const sidebarPhone = document.getElementById('sidebarPhone');
      const headerOwner = document.getElementById('headerOwner');

      if (headerPhone) headerPhone.textContent = state.profile.phone || '‚Äî';
      if (sidebarPhone) sidebarPhone.textContent = state.profile.phone || '‚Äî';
      if (headerOwner) headerOwner.textContent = state.profile.ownerName || '‚Äî';

      applyAccentTheme(state.profile.accent || '#3B82F6', state.profile.accentDepth);
    }

    function updateStats() {
      document.getElementById('statTotalLeads').textContent = 'Total leads: ' + state.leads.length;
      document.getElementById('statTotalProjects').textContent = 'Total projects: ' + state.projects.length;
    }

    function formatDateTime(value) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d)) return value;
      return d.toLocaleString(undefined, {
        day: '2-digit',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function isDueOrPast(value) {
      if (!value) return false;
      const d = new Date(value);
      if (isNaN(d)) return false;
      return d <= new Date();
    }

    function renderLeads(filterText = '') {
      const list = document.getElementById('leadsList');
      const empty = document.getElementById('emptyLeads');

      const q = filterText.trim().toLowerCase();
      const items = state.leads.slice().sort((a, b) => (b.id || 0) - (a.id || 0)).filter(l => {
        if (!q) return true;
        const inStr = (l.name + ' ' + l.phone + ' ' + (l.location || '') + ' ' + (l.requirement || '')).toLowerCase();
        return inStr.includes(q);
      });

      list.innerHTML = '';

      if (!items.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      items.forEach(lead => {
        const div = document.createElement('div');
        div.className = 'item-card';

        // Clicking card -> open detail, but ignore button clicks
        div.addEventListener('click', (e) => {
          if (e.target.closest('.mini-btn')) return;
          openLeadDetail(lead.id);
        });

        const header = document.createElement('div');
        header.className = 'item-header-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = lead.name || 'Unnamed lead';

        const status = document.createElement('span');
        status.className = 'status-pill';
        const hasFollow = !!lead.nextFollow;
        const overdue = hasFollow && isDueOrPast(lead.nextFollow);
        if (hasFollow) {
          status.textContent = (overdue ? 'Follow-up: ' : 'Next: ') + formatDateTime(lead.nextFollow);
          if (overdue) status.classList.add('overdue');
        } else {
          status.textContent = 'No follow-up set';
        }

        header.appendChild(title);
        header.appendChild(status);

        const line1 = document.createElement('div');
        line1.className = 'item-line full';
        line1.innerHTML = '<span>' + (lead.phone || '‚Äî') + '</span>' +
                          '<span>' + (lead.segment || 'Residential') + ' ‚Ä¢ ' + (lead.requirement || '') + '</span>';

        const line2 = document.createElement('div');
        line2.className = 'item-line full';
        line2.innerHTML = '<span>üìç ' + (lead.location || '‚Äî') + '</span>' +
                          '<span>üí∞ ' + (lead.budget || '‚Äî') + '</span>';

        const line3 = document.createElement('div');
        line3.className = 'item-line full';
        const lastNote = (lead.followups && lead.followups.length)
          ? lead.followups[lead.followups.length - 1].note
          : (lead.notes || '');
        if (lastNote) {
          line3.textContent = 'üìù ' + lastNote;
        } else {
          line3.textContent = '';
        }

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const wBtn = document.createElement('button');
        wBtn.className = 'mini-btn';
        wBtn.innerHTML = 'WhatsApp';
        wBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!lead.phone) return;
          const msg = encodeURIComponent('Hello ' + (lead.name || '') + ',\nThis is Hiren from Vamika Estate.');
          window.open('https://wa.me/91' + lead.phone.replace(/\D/g, '') + '?text=' + msg, '_blank');
        };

        const cBtn = document.createElement('button');
        cBtn.className = 'mini-btn';
        cBtn.textContent = 'Call';
        cBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!lead.phone) return;
          window.location.href = 'tel:' + lead.phone.replace(/\D/g, '');
        };

        actions.appendChild(wBtn);
        actions.appendChild(cBtn);

        div.appendChild(header);
        div.appendChild(line1);
        div.appendChild(line2);
        if (lastNote) div.appendChild(line3);
        div.appendChild(actions);
        list.appendChild(div);
      });
    }

    function renderProjects(filterText = '') {
      const list = document.getElementById('projectsList');
      const empty = document.getElementById('emptyProjects');

      const q = filterText.trim().toLowerCase();
      const items = state.projects.slice().sort((a, b) => (b.id || 0) - (a.id || 0)).filter(p => {
        if (!q) return true;
        const inStr = (p.name + ' ' + (p.location || '') + ' ' + (p.config || '') + ' ' + (p.description || '')).toLowerCase();
        return inStr.includes(q);
      });

      list.innerHTML = '';

      if (!items.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      items.forEach(project => {
        const card = document.createElement('div');
        card.className = 'item-card';

        // HEADER ROW: Name + small actions
        const header = document.createElement('div');
        header.className = 'item-header-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = project.name;

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'tiny-btn danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!confirm('Delete this project?')) return;
          state.projects = state.projects.filter(p => p.id !== project.id);
          saveProjects();
          renderProjects(document.getElementById('projectSearch').value);
        });

        actions.appendChild(deleteBtn);
        header.appendChild(title);
        header.appendChild(actions);

        // TOP LINE UNDER HEADER: first configuration line
        const cfgLine = document.createElement('div');
        cfgLine.className = 'item-line full';
        cfgLine.textContent = (project.config || '').split('\n')[0] || 'No configuration';

        // HIDDEN DETAIL SECTION
        const details = document.createElement('div');
        details.style.display = 'none';
        details.style.marginTop = '6px';
        details.className = 'project-detail';

        let html = '';
        if (project.location) html += 'üìç ' + project.location + '<br>';
        if (project.architect) html += 'üë∑ Architect: ' + project.architect + '<br>';
        if (project.landArea) html += 'üìê Land: ' + project.landArea + '<br>';
        if (project.units) html += 'üè¢ Units: ' + project.units + '<br>';
        if (project.blocks) html += 'üèó Blocks: ' + project.blocks + '<br>';
        if (project.floors) html += '‚¨Ü Floors: ' + project.floors + '<br>';

        html += '<br><b>Configurations:</b><br>';
        if (project.config) {
          html += project.config.split('\n').map(c => '‚Ä¢ ' + c).join('<br>');
        } else {
          html += '‚Äî';
        }

        html += '<br><br><b>Description:</b><br>';
        if (project.description) {
          html += project.description.split('\n').map(c => '‚Ä¢ ' + c).join('<br>');
        } else {
          html += '‚Äî';
        }

        const r = project.rate || {};
        html += '<br><br><b>Rate Details:</b><br>';
        if (r.basic) html += 'Basic: ' + r.basic + ' ' + (r.basicUnit || '') + '<br>';
        if (r.other) html += 'Other: ' + r.other + ' ' + (r.otherUnit || '') + '<br>';
        if (r.maintDeposit) html += 'Maint. Deposit: ' + r.maintDeposit + ' ' + (r.maintDepositUnit || '') + '<br>';
        if (r.running) html += 'Running Maint.: ' + r.running + ' ' + (r.runningUnit || '') + '<br>';

        const hasGardenPlc = r.plcGardenAmount && r.plcGardenUnit;
        const hasRoadPlc = r.plcRoadAmount && r.plcRoadUnit;
        if (hasGardenPlc || hasRoadPlc) {
          html += 'PLC:<br>';
          if (hasGardenPlc) {
            html += '&nbsp;&nbsp;- Garden: ' + r.plcGardenAmount + ' ' + r.plcGardenUnit + '<br>';
          }
          if (hasRoadPlc) {
            html += '&nbsp;&nbsp;- Road: ' + r.plcRoadAmount + ' ' + r.plcRoadUnit + '<br>';
          }
        }

        if (r.frcFrom || r.frcValue) {
          html += 'FRC: ' + (r.frcFrom || '') + ' ‚Üí ' + (r.frcValue || '') + '<br>';
        }

        details.innerHTML = html;

        // WhatsApp share button
        const shareBtn = document.createElement('button');
        shareBtn.className = 'tiny-btn';
        shareBtn.style.marginTop = '8px';
        shareBtn.textContent = 'Share on WhatsApp';
        shareBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const includeRates = confirm('Rate details sathe share karvu? (OK = Ha, Cancel = Na)');
          const msg = buildProjectWhatsappMessage(project, includeRates);
          window.open('https://wa.me/?text=' + encodeURIComponent(msg));
        });

        details.appendChild(shareBtn);

        card.appendChild(header);
        card.appendChild(cfgLine);
        card.appendChild(details);

        card.addEventListener('click', () => {
          details.style.display = details.style.display === 'none' ? 'block' : 'none';
        });

        list.appendChild(card);
      });
    }

    function buildProjectWhatsappMessage(project, includeRates) {
      const lines = [];

      lines.push('üè¢ *' + project.name + '*');
      if (project.location) lines.push('üìç ' + project.location);

      if (project.config) {
        lines.push('');
        lines.push('üõè *Configurations:*');
        project.config.split('\n').forEach(x => lines.push('‚Ä¢ ' + x));
      }

      if (project.units || project.blocks || project.floors || project.landArea || project.architect) {
        lines.push('');
        lines.push('üìå *Project Details:*');
        if (project.units) lines.push('‚Ä¢ Units: ' + project.units);
        if (project.blocks) lines.push('‚Ä¢ Blocks: ' + project.blocks);
        if (project.floors) lines.push('‚Ä¢ Floors: ' + project.floors);
        if (project.landArea) lines.push('‚Ä¢ Land: ' + project.landArea);
        if (project.architect) lines.push('‚Ä¢ Architect: ' + project.architect);
      }

      if (project.description) {
        lines.push('');
        lines.push('‚ú® *Highlights:*');
        project.description.split('\n').forEach(x => lines.push('‚Ä¢ ' + x));
      }

      if (includeRates && project.rate) {
        const r = project.rate;
        if (r.basic || r.other || r.maintDeposit || r.running || r.plcGardenAmount || r.plcRoadAmount || r.frcFrom || r.frcValue) {
          lines.push('');
          lines.push('üí∞ *Rate Details:*');
          if (r.basic) lines.push('‚Ä¢ Basic: ' + r.basic + ' ' + (r.basicUnit || ''));
          if (r.other) lines.push('‚Ä¢ Other: ' + r.other + ' ' + (r.otherUnit || ''));
          if (r.maintDeposit) lines.push('‚Ä¢ Maint. Deposit: ' + r.maintDeposit + ' ' + (r.maintDepositUnit || ''));
          if (r.running) lines.push('‚Ä¢ Running Maint.: ' + r.running + ' ' + (r.runningUnit || ''));

          const hasGardenPlc = r.plcGardenAmount && r.plcGardenUnit;
          const hasRoadPlc = r.plcRoadAmount && r.plcRoadUnit;
          if (hasGardenPlc || hasRoadPlc) {
            lines.push('‚Ä¢ PLC:');
            if (hasGardenPlc) {
              lines.push('   - Garden: ' + r.plcGardenAmount + ' ' + r.plcGardenUnit);
            }
            if (hasRoadPlc) {
              lines.push('   - Road: ' + r.plcRoadAmount + ' ' + r.plcRoadUnit);
            }
          }

          if (r.frcFrom || r.frcValue) {
            lines.push('‚Ä¢ FRC: ' + (r.frcFrom || '') + ' ‚Üí ' + (r.frcValue || ''));
          }
        }
      }

      lines.push('');
      lines.push('For more details contact *' + (state.profile.ownerName || 'Vamika Estate') + '*');

      return lines.join('\n');
    }

function renderFollowups() {
    // UPDATE SIDEBAR BADGE
    const now = new Date();
    const pending = state.leads.filter(l => {
        if (!l.nextFollow) return false;
        return new Date(l.nextFollow) <= now;
    });
    const badge = document.getElementById("sidebarFollowCount");
    if (badge) {
        if (pending.length > 0) {
            badge.textContent = pending.length;
            badge.style.display = "inline-block";
        } else {
            badge.style.display = "none";
        }
    }

    // UPDATE SIDEBAR BADGE
    try {
      const itemsCount = items.length;
      const badge = document.getElementById('sidebarFollowCount');
      if (badge) {
        if (itemsCount > 0) {
          badge.textContent = itemsCount;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    } catch(e){}

      const list = document.getElementById('followupsList');
      const empty = document.getElementById('emptyFollowups');

      const items = state.leads.filter(l => l.nextFollow && isDueOrPast(l.nextFollow))
                               .sort((a, b) => new Date(a.nextFollow) - new Date(b.nextFollow));

      list.innerHTML = '';

      if (!items.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      items.forEach(lead => {
        const div = document.createElement('div');
        div.className = 'item-card';

        div.addEventListener('click', (e) => {
          if (e.target.closest('.mini-btn')) return;
          openLeadDetail(lead.id);
        });

        const header = document.createElement('div');
        header.className = 'item-header-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = lead.name || 'Unnamed lead';

        const status = document.createElement('span');
        status.className = 'status-pill overdue';
        status.textContent = 'Due: ' + formatDateTime(lead.nextFollow);

        header.appendChild(title);
        header.appendChild(status);

        const line1 = document.createElement('div');
        line1.className = 'item-line full';
        line1.innerHTML = '<span>üìû ' + (lead.phone || '‚Äî') + '</span>' +
                          '<span>' + (lead.segment || 'Residential') + ' ‚Ä¢ ' + (lead.requirement || '') + '</span>';

        const line2 = document.createElement('div');
        line2.className = 'item-line full';
        line2.innerHTML = '<span>üìç ' + (lead.location || '‚Äî') + '</span>' +
                          '<span>üí∞ ' + (lead.budget || '‚Äî') + '</span>';

        const lastNote = (lead.followups && lead.followups.length)
          ? lead.followups[lead.followups.length - 1].note
          : (lead.notes || '');

        const line3 = document.createElement('div');
        line3.className = 'item-line full';
        if (lastNote) {
          line3.textContent = 'üìù ' + lastNote;
        }

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const doneBtn = document.createElement('button');
        doneBtn.className = 'mini-btn';
        doneBtn.innerHTML = 'Mark done';
        doneBtn.onclick = (ev) => {
          ev.stopPropagation();
          lead.nextFollow = null;
          saveLeads();
          renderLeads(document.getElementById('leadSearch').value);
          renderFollowups();
        };

        const wBtn = document.createElement('button');
        wBtn.className = 'mini-btn';
        wBtn.innerHTML = 'WhatsApp';
        wBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!lead.phone) return;
          const msg = encodeURIComponent('Hello ' + (lead.name || '') + ',\nFollowing up from Vamika Estate.');
          window.open('https://wa.me/91' + lead.phone.replace(/\D/g, '') + '?text=' + msg, '_blank');
        };

        const cBtn = document.createElement('button');
        cBtn.className = 'mini-btn';
        cBtn.textContent = 'Call';
        cBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!lead.phone) return;
          window.location.href = 'tel:' + lead.phone.replace(/\D/g, '');
        };

        actions.appendChild(doneBtn);
        actions.appendChild(wBtn);
        actions.appendChild(cBtn);

        div.appendChild(header);
        div.appendChild(line1);
        div.appendChild(line2);
        if (lastNote) div.appendChild(line3);
        div.appendChild(actions);
        list.appendChild(div);
      });
    }

    function openLeadModal(lead) {
      const modal = document.getElementById('leadModal');
      const title = document.getElementById('leadModalTitle');

      if (lead) {
        editingLeadId = lead.id;
        title.textContent = 'Edit Lead';
        document.getElementById('leadName').value = lead.name || '';
        document.getElementById('leadPhone').value = lead.phone || '';
        document.getElementById('leadSegment').value = lead.segment || 'Residential';
        document.getElementById('leadRequirement').value = lead.requirement || '';
        document.getElementById('leadLocation').value = lead.location || '';
        document.getElementById('leadBudget').value = lead.budget || '';
        document.getElementById('leadNextFollow').value = lead.nextFollow || '';
        document.getElementById('leadNotes').value = lead.notes || '';
      } else {
        editingLeadId = null;
        title.textContent = 'Add Lead';
        document.getElementById('leadName').value = '';
        document.getElementById('leadPhone').value = '';
        document.getElementById('leadSegment').value = 'Residential';
        document.getElementById('leadRequirement').value = '';
        document.getElementById('leadLocation').value = '';
        document.getElementById('leadBudget').value = '';
        document.getElementById('leadNextFollow').value = '';
        document.getElementById('leadNotes').value = '';
      }

      modal.classList.remove('hidden');
    }

    function closeLeadModal() {
      document.getElementById('leadModal').classList.add('hidden');
      editingLeadId = null;
    }

    function openProjectModal() {
      document.getElementById('projectModal').classList.remove('hidden');
    }

    function closeProjectModal() {
      document.getElementById('projectModal').classList.add('hidden');
      document.getElementById('projectName').value = '';
      document.getElementById('projectLocation').value = '';
      document.getElementById('projectArchitect').value = '';
      document.getElementById('projectLandArea').value = '';
      document.getElementById('projectUnits').value = '';
      document.getElementById('projectBlocks').value = '';
      document.getElementById('projectFloors').value = '';
      document.getElementById('projectConfig').value = '';
      document.getElementById('projectDescription').value = '';

      document.getElementById('rateBasic').value = '';
      document.getElementById('rateBasicUnit').value = '';
      document.getElementById('rateOtherAmount').value = '';
      document.getElementById('rateOtherUnit').value = '';
      document.getElementById('rateMaintDepositAmount').value = '';
      document.getElementById('rateMaintDepositUnit').value = '';
      document.getElementById('rateRunningAmount').value = '';
      document.getElementById('rateRunningUnit').value = '';
      document.getElementById('rateFrcFrom').value = '';
      document.getElementById('rateFrcValue').value = '';
      document.getElementById('ratePlcGardenAmount').value = '';
      document.getElementById('ratePlcGardenUnit').value = '';
      document.getElementById('ratePlcRoadAmount').value = '';
      document.getElementById('ratePlcRoadUnit').value = '';
    }

    function openLeadDetail(id) {
      const modal = document.getElementById('leadDetailModal');
      const body = document.getElementById('leadDetailBody');
      const lead = state.leads.find(l => l.id === id);
      if (!lead) return;
      currentLeadId = id;

      const followups = (lead.followups || []).slice().sort((a, b) => new Date(b.at) - new Date(a.at));

      let html = '';
      html += '<div class="field-group"><div class="field-label">Name</div><div>' + (lead.name || '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Phone</div><div>' + (lead.phone || '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Segment</div><div>' + (lead.segment || 'Residential') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Requirement</div><div>' + (lead.requirement || '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Location</div><div>' + (lead.location || '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Budget</div><div>' + (lead.budget || '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Next follow-up</div><div>' +
              (lead.nextFollow ? formatDateTime(lead.nextFollow) : '‚Äî') + '</div></div>';
      html += '<div class="field-group"><div class="field-label">Notes</div><div>' + (lead.notes || '‚Äî') + '</div></div>';

      html += '<div class="section-label" style="margin-top:10px;">Follow-up history</div>';
      if (!followups.length) {
        html += '<div style="font-size:11px;color:var(--muted);margin-top:2px;">No follow-up notes yet.</div>';
      } else {
        html += '<div class="history-list">';
        followups.forEach(f => {
          html += '<div class="history-item"><span class="history-date">' +
                  formatDateTime(f.at) +
                  '</span> - <span>' + (f.note || '') + '</span></div>';
        });
        html += '</div>';
      }

      body.innerHTML = html;

      document.getElementById('detailFollowNote').value = '';
      document.getElementById('detailFollowWhen').value = '';

      modal.classList.remove('hidden');
    }

    function closeLeadDetail() {
      document.getElementById('leadDetailModal').classList.add('hidden');
      currentLeadId = null;
    }

    function setupTheme() {
      const btnLight = document.getElementById('btnLight');
      const btnDark = document.getElementById('btnDark');
      let saved = localStorage.getItem(STORAGE_KEYS.theme) || 'dark';

      function apply(mode) {
        saved = mode;
        localStorage.setItem(STORAGE_KEYS.theme, mode);

        if (mode === 'light') {
          if (typeof state.profile.accentDepth !== 'number' || state.profile.accentDepth > 70) {
            state.profile.accentDepth = 30;
          }
          if (btnLight) btnLight.classList.add('active');
          if (btnDark) btnDark.classList.remove('dark-active');
        } else {
          if (typeof state.profile.accentDepth !== 'number' || state.profile.accentDepth < 30) {
            state.profile.accentDepth = 70;
          }
          if (btnDark) btnDark.classList.add('dark-active');
          if (btnLight) btnLight.classList.remove('active');
        }

        const depthSlider = document.getElementById('themeDepth');
        if (depthSlider) depthSlider.value = state.profile.accentDepth;

        applyAccentTheme(state.profile.accent || '#3B82F6', state.profile.accentDepth);
        saveProfile();
      }

      if (btnLight) btnLight.addEventListener('click', () => apply('light'));
      if (btnDark) btnDark.addEventListener('click', () => apply('dark'));

      apply(saved);
    }

    function exportLeadsAsCsv() {
      if (!state.leads.length) {
        alert('No leads to export yet.');
        return;
      }
      const header = ['Name','Phone','Segment','Requirement','Location','Budget','NextFollow','Notes'];
      const rows = state.leads.map(l => [
        l.name || '',
        l.phone || '',
        l.segment || '',
        l.requirement || '',
        l.location || '',
        l.budget || '',
        l.nextFollow || '',
        l.notes || ''
      ]);
      const all = [header, ...rows];
      const csv = all.map(r => r.map(field => '"' + String(field).replace(/"/g,'""') + '"').join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vamika-leads.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportLeadsAsExcel() {
      if (!state.leads.length) {
        alert('No leads to export yet.');
        return;
      }
      const header = ['Name','Phone','Segment','Requirement','Location','Budget','NextFollow','Notes'];
      const rows = state.leads.map(l => [
        l.name || '',
        l.phone || '',
        l.segment || '',
        l.requirement || '',
        l.location || '',
        l.budget || '',
        l.nextFollow || '',
        l.notes || ''
      ]);
      const all = [header, ...rows];
      const csv = all.map(r => r.map(field => '"' + String(field).replace(/"/g,'""') + '"').join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'application/vnd.ms-excel;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vamika-leads.xls';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadJsonBackup() {
      const data = {
        leads: state.leads,
        projects: state.projects,
        profile: state.profile
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vamika-crm-backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function restoreFromJson(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          state.leads = data.leads || [];
          state.projects = data.projects || [];
          if (data.profile) Object.assign(state.profile, data.profile);
          saveLeads();
          saveProjects();
          saveProfile();
          applyProfileToUI();
          renderLeads(document.getElementById('leadSearch').value);
          renderProjects(document.getElementById('projectSearch').value);
          renderFollowups();
          alert('Backup restored successfully.');
        } catch (err) {
          console.error(err);
          alert('Could not restore backup. File may be invalid.');
        }
      };
      reader.readAsText(file);
    }

    function activateSection(tabKey) {
      const map = {
        leads: 'tab-leads',
        projects: 'tab-projects',
        followups: 'tab-followups',
        settings: 'tab-settings'
      };
      Object.entries(map).forEach(([key, id]) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (key === tabKey) el.classList.add('active');
        else el.classList.remove('active');
      });

      document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === tabKey);
      });
    }

    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const toggle = document.getElementById('menuToggle');

      function open() {
        sidebar.classList.add('open');
        overlay.classList.add('open');
      }

      function close() {
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
      }

      toggle.addEventListener('click', open);
      overlay.addEventListener('click', close);

      document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.section;
          activateSection(key);
          close();
        });
      });

      activateSection('leads');
    }

    function setupPWA() {
      const installBtn = document.getElementById('installBtn');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'inline-flex';
      });

      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        try {
          await deferredPrompt.userChoice;
        } catch (e) {
          console.error(e);
        }
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed', err));
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadState();
      setupTheme();
      applyProfileToUI();
      updateStats();
      renderLeads();
      renderProjects();
      renderFollowups();
      setupSidebar();
      setupPWA();

      document.getElementById('btnNewLead').addEventListener('click', () => openLeadModal(null));
      document.getElementById('btnEmptyNewLead').addEventListener('click', () => openLeadModal(null));
      document.querySelectorAll('[data-close-lead]').forEach(btn => {
        btn.addEventListener('click', closeLeadModal);
      });

      document.getElementById('btnNewProject').addEventListener('click', openProjectModal);
      document.getElementById('btnEmptyNewProject').addEventListener('click', openProjectModal);
      document.querySelectorAll('[data-close-project]').forEach(btn => {
        btn.addEventListener('click', closeProjectModal);
      });

      document.querySelectorAll('[data-close-detail]').forEach(btn => {
        btn.addEventListener('click', closeLeadDetail);
      });

      document.getElementById('btnSaveLead').addEventListener('click', () => {
        const name = document.getElementById('leadName').value.trim();
        const phone = document.getElementById('leadPhone').value.trim();
        if (!name || !phone) {
          alert('Name and phone are required.');
          return;
        }
        if (editingLeadId) {
          const lead = state.leads.find(l => l.id === editingLeadId);
          if (lead) {
            lead.name = name;
            lead.phone = phone;
            lead.segment = document.getElementById('leadSegment').value;
            lead.requirement = document.getElementById('leadRequirement').value.trim();
            lead.location = document.getElementById('leadLocation').value.trim();
            lead.budget = document.getElementById('leadBudget').value.trim();
            lead.nextFollow = document.getElementById('leadNextFollow').value;
            lead.notes = document.getElementById('leadNotes').value.trim();
          }
        } else {
          const lead = {
            id: Date.now(),
            name,
            phone,
            segment: document.getElementById('leadSegment').value,
            requirement: document.getElementById('leadRequirement').value.trim(),
            location: document.getElementById('leadLocation').value.trim(),
            budget: document.getElementById('leadBudget').value.trim(),
            nextFollow: document.getElementById('leadNextFollow').value,
            notes: document.getElementById('leadNotes').value.trim(),
            followups: []
          };
          state.leads.unshift(lead);
        }
        saveLeads();
        closeLeadModal();
        renderLeads(document.getElementById('leadSearch').value);
        renderFollowups();
      });

      document.getElementById('btnSaveProject').addEventListener('click', () => {
        const name = document.getElementById('projectName').value.trim();
        if (!name) {
          alert('Project name is required.');
          return;
        }

        const project = {
          id: Date.now(),
          name,
          location: document.getElementById('projectLocation').value.trim(),
          architect: document.getElementById('projectArchitect').value.trim(),
          landArea: document.getElementById('projectLandArea').value.trim(),
          units: document.getElementById('projectUnits').value.trim(),
          blocks: document.getElementById('projectBlocks').value.trim(),
          floors: document.getElementById('projectFloors').value.trim(),
          config: document.getElementById('projectConfig').value.trim(),
          description: document.getElementById('projectDescription').value.trim(),
          rate: {
            basic: document.getElementById('rateBasic').value.trim(),
            basicUnit: document.getElementById('rateBasicUnit').value,
            other: document.getElementById('rateOtherAmount').value.trim(),
            otherUnit: document.getElementById('rateOtherUnit').value,
            maintDeposit: document.getElementById('rateMaintDepositAmount').value.trim(),
            maintDepositUnit: document.getElementById('rateMaintDepositUnit').value,
            running: document.getElementById('rateRunningAmount').value.trim(),
            runningUnit: document.getElementById('rateRunningUnit').value,
            plcGardenAmount: document.getElementById('ratePlcGardenAmount').value.trim(),
            plcGardenUnit: document.getElementById('ratePlcGardenUnit').value,
            plcRoadAmount: document.getElementById('ratePlcRoadAmount').value.trim(),
            plcRoadUnit: document.getElementById('ratePlcRoadUnit').value,
            frcFrom: document.getElementById('rateFrcFrom').value.trim(),
            frcValue: document.getElementById('rateFrcValue').value.trim()
          }
        };

        state.projects.unshift(project);
        saveProjects();
        closeProjectModal();
        renderProjects(document.getElementById('projectSearch').value);
      });

      document.getElementById('leadSearch').addEventListener('input', (e) => {
        renderLeads(e.target.value);
      });

      document.getElementById('projectSearch').addEventListener('input', (e) => {
        renderProjects(e.target.value);
      });

      document.getElementById('btnSaveProfile').addEventListener('click', () => {
        state.profile.businessName = document.getElementById('businessName').value.trim() || 'Vamika Estate';
        state.profile.ownerName = document.getElementById('ownerName').value.trim() || 'Hiren Gohel';
        state.profile.phone = document.getElementById('ownerPhone').value.trim() || '7046869462';

        let accentHex = document.getElementById('themeAccent').value.trim() || '#3B82F6';
        if (!accentHex.startsWith('#')) accentHex = '#' + accentHex;
        state.profile.accent = accentHex;

        const depthSlider = document.getElementById('themeDepth');
        state.profile.accentDepth = depthSlider ? (parseInt(depthSlider.value, 10) || 70) : 70;

        saveProfile();
        applyProfileToUI();
        alert('Profile saved.');
      });

      document.getElementById('btnExportCsv').addEventListener('click', exportLeadsAsCsv);
      document.getElementById('btnExportExcel').addEventListener('click', exportLeadsAsExcel);
      document.getElementById('btnDownloadJson').addEventListener('click', downloadJsonBackup);
      document.getElementById('restoreFile').addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          restoreFromJson(e.target.files[0]);
        }
      });

      // Detail modal buttons
      document.getElementById('btnDetailWhatsapp').addEventListener('click', () => {
        const lead = state.leads.find(l => l.id === currentLeadId);
        if (!lead || !lead.phone) return;
        const msg = encodeURIComponent('Hello ' + (lead.name || '') + ',\nThis is Hiren from Vamika Estate.');
        window.open('https://wa.me/91' + lead.phone.replace(/\D/g, '') + '?text=' + msg, '_blank');
      });

      document.getElementById('btnDetailCall').addEventListener('click', () => {
        const lead = state.leads.find(l => l.id === currentLeadId);
        if (!lead || !lead.phone) return;
        window.location.href = 'tel:' + lead.phone.replace(/\D/g, '');
      });

      document.getElementById('btnDetailEdit').addEventListener('click', () => {
        const lead = state.leads.find(l => l.id === currentLeadId);
        if (!lead) return;
        closeLeadDetail();
        openLeadModal(lead);
      });

      document.getElementById('btnDetailDelete').addEventListener('click', () => {
        if (!confirm('Delete this lead?')) return;
        state.leads = state.leads.filter(l => l.id !== currentLeadId);
        saveLeads();
        closeLeadDetail();
        renderLeads(document.getElementById('leadSearch').value);
        renderFollowups();
      });

      document.getElementById('btnDetailAddFollow').addEventListener('click', () => {
        const lead = state.leads.find(l => l.id === currentLeadId);
        if (!lead) return;
        const whenVal = document.getElementById('detailFollowWhen').value || new Date().toISOString();
        const note = document.getElementById('detailFollowNote').value.trim();
        if (!note) {
          alert('Please enter a note.');
          return;
        }
        if (!lead.followups) lead.followups = [];
        lead.followups.push({
          id: Date.now(),
          at: whenVal,
          note
        });
        // also update next follow-up date/time
        lead.nextFollow = whenVal;
        saveLeads();
        document.getElementById('detailFollowNote').value = '';
        document.getElementById('detailFollowWhen').value = '';
        // refresh detail + lists
        openLeadDetail(currentLeadId);
        renderLeads(document.getElementById('leadSearch').value);
        renderFollowups();
      });

      // Live theme accent controls
      const accentInput = document.getElementById('themeAccent');
      const picker = document.getElementById('themeAccentPicker');
      const depthSlider = document.getElementById('themeDepth');

      if (picker) {
        picker.addEventListener('input', (e) => {
          const hex = e.target.value;
          if (accentInput) accentInput.value = hex;
          state.profile.accent = hex;
          saveProfile();
          applyAccentTheme(state.profile.accent, state.profile.accentDepth);
        });
      }

      if (accentInput) {
        accentInput.addEventListener('change', (e) => {
          let hex = e.target.value.trim();
          if (!hex) hex = '#3B82F6';
          if (!hex.startsWith('#')) hex = '#' + hex;
          e.target.value = hex;
          if (picker) picker.value = hex;
          state.profile.accent = hex;
          saveProfile();
          applyAccentTheme(state.profile.accent, state.profile.accentDepth);
        });
      }

      if (depthSlider) {
        depthSlider.addEventListener('input', (e) => {
          const v = parseInt(e.target.value, 10) || 70;
          state.profile.accentDepth = v;
          saveProfile();
          applyAccentTheme(state.profile.accent || '#3B82F6', state.profile.accentDepth);
        });
      }
    });
  </script>
</body>
</html>
